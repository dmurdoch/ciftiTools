---
title: "`ciftiTools` Demo"
author: "Damon Pham & Amanda Mejia"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{`ciftiTools` Demo}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r include=FALSE}
library(knitr)
knitr::opts_chunk$set(autodep = TRUE, cache = FALSE)
```

`ciftiTools` is an R package for working with CIFTI-2 format brain imaging data. Used in conjunction with GIFTI surface geometry files, CIFTI files enable surface-based analysis of grey matter data, which has several advantages over traditional volumetric/voxel-based analysis. Because of this, the CIFTI-2 format is used by recent neuroimaging studies including the Human Connectome Project (HCP). `ciftiTools` supports reading, writing, visualizing, resampling, and other operations for CIFTI files with the `".dscalar.nii"`, `".dtseries.nii"`, and `".dlabel.nii"` intents. Several of these operations are made possible by the [Connectome Workbench](https://www.humanconnectome.org/software/connectome-workbench). 

To get started, the first time you use the `ciftiTools` package, install it via either CRAN (with `install.packages()`) 
or Github (with `install_github()` from the `devtools` package). Here, we will use the CRAN version.

```{r}
# Check if package installed. If not, install it.
if(!require('ciftiTools')){
  install.packages('ciftiTools')
  #install_github('mandymejia/ciftiTools') # development version
  library(devtools)
}
```

Now we load the `ciftiTools` package. 

```{r}
library(ciftiTools)
```

Next, we indicate where to find the Connectome Workbench. This can be the full path to the Connectome Workbench executable file, or the path to its containing folder, in which case `ciftiTools` will locate the full path. Here, we will use the latter:

```{r}
# Replace '/Applications/workbench' with the actual path to 
#   the Connectome Workbench folder on your computer.
#   If successful, the full path to the Workbench executable will be printed.
ciftiTools.setOption('wb_path', '../../workbench')
```

In this vignette, we will use example data included in the `ciftiTools` package. The files are originally from [NITRC](https://www.nitrc.org/frs/?group_id=454):

* The "MyelinAndCorrThickness" dtseries and dscalar files contain the same data: MyelinMap_BC_decurv and corrThickness
* The dlabel file contains three cortical parcellations
* The "ones" dscalar file is the only file to include subcortical voxels. All its data values are 1. 
* To reduce the size of `ciftiTools`, the dscalar and dlabel CIFTIs were resampled to 6k and the "ones" dscalar was resampled to 1k.

We will also use GIFTI files containing very inflated surface geometry.

```{r}
cifti_fnames <- ciftiTools::demo_files()$cifti
surfL_fname <- ciftiTools::demo_files()$surf["left"]
surfR_fname <- ciftiTools::demo_files()$surf["right"]
```

# Reading and Writing

### Reading

CIFTI files organize the gray matter of the brain into "greyordinates": vertices representing the left and right cortical surfaces, and voxels representing the subcortical gray matter structures and the cerebellum. A CIFTI file consists of two parts: (1) a NIFTI XML header which contains all the metadata including medial wall locations, subcortical structure labels, and the subcortical volumetric mask; and (2) a matrix representing all the greyordinate data. These components are read in together with `read_cifti`:

```{r, warning=FALSE}
basename(cifti_fnames["dscalar"])
xii <- read_xifti(cifti_fnames["dscalar"])
xii
#plot(xii) # for visualization, we'll get to that next!
```

By default, `read_cifti` only reads in the left and right cortex data. The subcortical data can be included by using the argument `brainstructures="all"`. Other brainstructure combinations can be specified too, e.g. `brainstructures=c("left", "subcortical")`. The full set of choices for brainstructures is any combination of `"left"`, `"right"` and `"subcortical"`, or `"all"` for all three.

The resulting object produced by `read_cifti` is a `"xifti"` with components `data` (the greyordinate data matrix, separated by brainstructure), `meta` (metadata, most of which is from the NIFTI XML header), and `surf` (surface geometry). The last component distinguishes a `"xifti"` from a CIFTI: the left and right cortical surface geometries are not included in CIFTI files, so they must be read from separate surface GIFTI files (ending in `surf.gii`). The surface must be compatible: the number of vertices must be the same, and each vertex in the CIFTI data must correspond to the vertex location in the corresponding GIFTI surface file. In this way, a `"xifti"` represents a combination of a CIFTI file with compatible GIFTI files for the cortical mesh.

We can add GIFTI surface geometries like so:

```{r}
basename(cifti_fnames["dtseries"])
xii <- read_xifti(cifti_fnames["dtseries"])
xii <- add_surf(xii, surfL=surfL_fname, surfR=surfR_fname)
xii
```

Alternatively, we could have provided the surface geometries at the outset of reading the CIFTI file:

```{r}
xii2 <- read_xifti(cifti_fnames["dtseries"], surfL_fname=surfL_fname, surfR_fname=surfR_fname)
all.equal(xii, xii2) # same result
```

To only read the CIFTI header, use `info_cifti`:

```{r}
xii_info <- ciftiTools::info_cifti(cifti_fnames["dscalar"])
str(xii_info) # shows header structure
```

To only read in certain columns, use the `idx` argument:

```{r}
read_xifti(cifti_fnames["dtseries"], idx=2) # second column only
```

### Writing

When `"xifti"` object is written to files, the CIFTI components are placed in a CIFTI file and the surface geometries, if any, are placed in GIFTI files.

```{r}
out_dir <- "output"

write_xifti(
  xii, file.path(out_dir, "my_cifti.dtseries.nii"), 
  file.path(out_dir, "my_L.surf.gii"), file.path(out_dir, "my_R.surf.gii")
)
```

With `separate_cifti`, a CIFTI can be separated and written into its component parts: the cortical data can be written to GIFTI metric files, and the subcortical data can be written to a NIFTI file. In addition, any ROIs or labels will also be written to files. The files are automatically named unless a new file name is provided.

```{r}
# Use default names for everything except left cortex
separated_fnames = separate_cifti(
  cifti_fnames["dscalar_ones"], brainstructures="all", 
  cortexL_fname="my_left_cortex.func.gii", write_dir = out_dir
)
# Files written to `out_dir`, or current working dir. if not specified
basename(separated_fnames)
```

Separated files can be read into R with the `oro.nifti`/`RNifti` and `gifti` packages, and combined into a `"xifti"` object with `as.xifti`.

# Visualization

`ciftiTools` graphics are made possible by the `rgl` package. To prepare the R Markdown document for knitting we need to do the following: 

```{r}
library(rgl)
rgl::setupKnitr()

# Sometimes the first RGL window does not render properly.
rgl::rgl.open(); rgl::rgl.close()
```

Now let's take a look! 

### Surface visualization

`view_xifti_surface(xii)` displays the cortical data on the surface mesh. This function has several primary arguments:

* `color_mode` specifies the nature of the data values: `"sequential"`, `"qualitative"` and `"diverging"`. If it is not provided, a default mode that makes sense for the data will be used.
* `colors` specifies the color palette to use. If it is not provided, a default palette that makes sense for the `color_mode` is used.
* `idx` controls which column(s) to display.
* `widget` and `fname` control the output type. If `fname` is not provided, an interactive plot is created: by default, an Open GL window if the length of `idx` is one, and an embedded htmlwidget if the length of `idx` is greater than one. `widget` can be used to override this default. On the other hand, if `fname` is provided, static image (png) files for each `idx` are created, unless `fname` ends in `.html` in which case a separate, interactive html file will be saved. Lastly, Open GL windows can be embedded in R Markdown documents for knitting; refer to the source code of this vignette to see how this works.
* `surfL` and `surfR` specify the surface geometry to plot the data on. If not provided, the "inflated" surfaces included in `ciftiTools` are used. The default surface can also be changed to "very inflated" or "midthickness" by e.g. `ciftiTools.setOption("surf", "very inflated")`.

Let's see an example using each `color_mode` option. Note how the included surfaces are used in the first plot, but if none are present as in the second and third plots, the default surfaces are automatically used for visualization. We'll also make the second plot interactive by requesting display of two `idx`. Try clicking and dragging around the second plot to rotate, and scrolling to zoom in and out.

```{r, fig.cap="dtseries file; first column; sequential palette", rgl=TRUE, format="png", fig.height=4.2, fig.width=5}
# Normally `cex.title` doesn't need to be set, as it defaults to a good choice.
#   But when knitting static images this way, the default becomes a bit too big
#   based on how knitting works.
view_xifti_surface(xii, idx=1, zlim=c(1,2), title='color_mode = "sequential"', cex.title=1.3)
```

```{r fig.height=4.2, fig.width=5}
xii <- read_cifti(cifti_fnames["dscalar"]) # no GIFTI included, so the default inflated surface is used.
view_xifti_surface(
  xii, idx=1:2, zlim=c(0,5), color_mode = "diverging",
  title='color_mode = "diverging"', cex.title=1.3
)
```

```{r, fig.cap="dlabel file; first label; palette from label metadata", rgl=TRUE, format="png", fig.height=3.8, fig.width=5}
dlabel <- view_xifti_surface(
  read_cifti(cifti_fnames["dlabel"]), 
  # Interactively, a color legend that displays the label names will also be printed.
  legend_ncol=5, 
  title='color_mode = "qualitative"', cex.title=1.3
)
```

(Note that the dtseries used in this example does not truly contain fMRI BOLD timeseries data, but we use it for illustration.)

### Volume visualization

`view_xifti_volume(xii)` displays the subcortical data in slices. To view interactively in a web browser, set `interactive=TRUE`. By default, a series of slices is displayed overlaid on the MNI template.  The orientation, numbers of slices, index and value range can be adjusted.

```{r, fig.cap="Subcortical data (all ones)", fig.height=6, fig.width=4}
# cifti_fnames["dscalar_ones"] is the only file with subcortical data
xii <- read_cifti(cifti_fnames["dscalar_ones"], brainstructures="subcortical")
view_xifti_volume(xii)
```

```{r eval=FALSE}
# For information only, since papaya viewer cannot be opened during knitting
view_xifti_volume(xii, interactive = TRUE)
```

The S3 method `plot(xii)` will display the cortical data if possible, and the subcortical data otherwise. 

# Resampling and smoothing

### Resampling

`ciftiTools` can resample CIFTI files to a lower resolution. Here, we resample the 32k dtseries file to 6k vertices. We also provide the surfaces and resample them in conjunction.

```{r}
resampled_xii_fname <- "my_new_resampled.dtseries.nii"
resampled_surfL_fname <- "my_resampled_surfL.surf.gii"
resampled_surfR_fname <- "my_resampled_surfR.surf.gii"
  
xii_6k <- resample_cifti(
  cifti_fnames["dtseries"], resampled_xii_fname,
  resamp_res = 2000,
  surfL_fname, surfR_fname,
  resampled_surfL_fname, resampled_surfR_fname,
  write_dir = out_dir
)
basename(xii_6k)
```

Resampling can also be performed while reading a file into R. 

```{r}
read_cifti(cifti_fnames["dscalar"], resamp_res=2000)
```

### Smoothing

Use `smooth_cifti` to perform smoothing. This function works for both CIFTI files and `"xifti"` objects.

```{r, fig.cap="Smoothed CIFTI", rgl=TRUE, format="png", fig.height=3.8, fig.width=5}
smoothed_xii_fname <- "my_smoothed_cifti.dtseries.nii"
smooth_cifti(
  cifti_fnames["dtseries"], file.path(out_dir, smoothed_xii_fname),
  surf_FWHM=2, vol_FWHM=2,
  surfL_fname=surfL_fname, surfR_fname=surfR_fname,
  subcortical_zeroes_as_NA=TRUE
)
# Demonstrating the ability to use RColorBrewer palettes!
plot(
  read_cifti(file.path(out_dir, smoothed_xii_fname)), 
  surfL=surfL_fname, surfR=surfR_fname, 
  zlim=c(1,2), color_mode="diverging", colors="Spectral"
)
```

# Manipulation & Math

`apply_xifti` applies a function along the rows or columns of a `"xifti"`. The `apply` function also works on `"xifti"` objects. The former will return a `"xifti"` whereas the latter will return a data matrix.

```{r}
xiiL <- read_xifti(cifti_fnames["dscalar"], brainstructures="left")
apply_xifti(xiiL, 2, mean)
```

`combine_xifti` combines multiple `"xifti"`s with different brainstructures.

```{r}
xiiR <- read_xifti(cifti_fnames["dscalar"], brainstructures="right")
xii <- combine_xifti(xiiL, xiiR)
xii
```

`merge_xifti` concatenates metric data from multiple `"xifti"`s column-wise.

```{r}
xii <- merge_xifti(xii, xii) # Columns are repeated twice now.
```

`remove_xifti` removes a brainstructure(s) from a `"xifti"`.

```{r}
xii <- remove_xifti(xii, "cortex_left") # Now only the right cortex data is included.
xii
```

`select_xifti` subsets or re-orders the columns of the metric data of a `"xifti"`.

```{r}
xii <- select_xifti(xii, c(4,3,2,1)) # Reverse the order of the columns
xii
```

`apply_xifti` works like the R `apply` function, applying a function to the rows or columns of a `"xifti"`.

```{r}
gmeans <- apply_xifti(xii, 1, mean) # Mean of each greyordinate
gmeans
```

```{r}
cquants <- apply_xifti(xii, 2, quantile, c(.1, .5)) # Quantiles of each column
cquants
```

`convert_xifti` converts the intent of a `"xifti"`.

```{r}
xii <- convert_xifti(read_xifti(cifti_fnames["dtseries"]), "dscalar")
xii$meta$cifti$intent
```

S3 methods allow for univariate transformations of `"xifti"` objects as well as arithmetic operations of multiple `"xifti"` objects.

```{r}
xii <- 1 + exp(xii) + (xii / 3)
xii
```

# Working with surfaces

`ciftiTools` also includes functionality for working with surface geometry GIFTI files separately from any metric data. Surfaces that are read in are `"surf"` objects:

```{r}
# Reading
ciftiTools.setOption("surf", "midthickness") # let's use a different surface here
surf <- read_surf(demo_files()$surf["left"])
surf
```

These can be written back to GIFTI files, visualized, and resampled. Resampling can be performed on the `"surf"` objects or the surface GIFTI files directly:


```{r, rgl=TRUE, format="png", fig.height=3.8, fig.width=2.5}
# Writing
write_surf_gifti(surf, file.path(out_dir, "my.L.surf"))

# Visualizing
plot(surf)

# Resample a `"surf"` object
surf <- resample_surf(surf, 2000, "left")
# Resample a GIFTI file
resample_gifti(surfL_fname, file.path(out_dir, "my.L.2k.surf.gii"), "left", resamp_res=2000)
```

Lastly, let's demonstrate the ability to plot vertices and edges. (This can also be done when plotting `"xifti"` objects using the same arguments.)

```{r, rgl=TRUE, format="png", fig.height=3.8, fig.width=2.5}
# Recall that surf was resampled to 2k
plot(surf, vertex_size=3, vertex_color="blue")
```

```{r, rgl=TRUE, format="png", fig.height=3.8, fig.width=2.5}
plot(surf, edge_color="black")
```
